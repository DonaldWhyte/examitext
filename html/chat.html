<html>

<head>
	<title>Chat Analyser</title>

	<!-- External libraries -->
	<script type="text/javascript" src="../js/jquery-1.6.2.js"></script>
	<script type="text/javascript" src="../js/highcharts.js"></script>
	<script type="text/javascript" src="../js/split.js"></script>

	<script type="text/javascript" src="../js/highcharts_wrapper.js"></script>

	<script type="text/javascript" src="../js/util.js"></script>
	<script type="text/javascript" src="../js/stemmer.js"></script>
	<script type="text/javascript" src="../js/stoplist.js"></script>
	<script type="text/javascript" src="../js/log_processor.js"></script>
	<script type="text/javascript">
	/* Useful for dynamically placing elements at the centre of the screen. */
	jQuery.fn.center_x = function() {
		this.css("position","absolute");
		this.css("left", (($(window).width() - this.outerWidth()) / 2) + $(window).scrollLeft() + "px");
	}
	jQuery.fn.center_y = function() {
		this.css("position","absolute");
		this.css("top", (($(window).height() - this.outerHeight()) / 2) + $(window).scrollTop() + "px");
	}
	jQuery.fn.center = function() {
		this.center_x();
		this.center_y();
	    return this;
	}
	
	/* Retrives text from the raw text area. */
	function getText() {
		var rawText = document.forms("logForm").elements["rawText"];
		return rawText.value;
	}

	/* Called when the analyse button is clicked. */
	function analyse() {
		// Get source text
		var text = getText();
		if (text != undefined && text != "") {
			// Calclate statistics
			var stemmerObject = new Stemmer(sanitiseWord, stemmer);
			var stoplist = new Stoplist(STOP_LIST);
			var messages = processLog(text, stemmerObject, stoplist);
			var stats = new ChatStatistics(messages);

			// Now interpret them and show them
			var statTable =  "<table><th>Participant</th>" +
			"<th>Percent of Messages</th><th>Number of Messages</th><th>Average Message " +
			"Length</th><th>Average Message Density</th><th>Word Count</th>";
			var pieChartData = [ ];

			for (var name in stats.participants) {
				var participant = stats.participants[name];

				statTable += "<tr><td>" + name + "</td><td>" + roundNumber(participant.percentOfMessages, 2) +
					"%</td><td>" + participant.getMessageCount() + "</td><td>" + roundNumber(participant.getAverageMessageLength(), 2) +
					"</td><td>" + roundNumber(participant.getAverageMessageDensity(), 2) + "</td><td>" + participant.getWordCount() + "</tr>";
				pieChartData.push([name, participant.percentOfMessages]);
			}

			statTable += "</table>";

			// Generates tables to show the top 10 words for each participant
			var topWordTables = [];
			for (var name in stats.participants) {
				var current = "<table class='topTable'><tr><th colspan='3'><span class='top1 text_center'>" + name +
					"'s Top 10 Words</span></th></tr><tr><th>Word</th><th>Frequency</th><th>Relative Frequency</th></tr>";

				var topWords = stats.participants[name].getMostSaidWords(10);
				for (var i in topWords) {
					if (i >= 0 && i <= 2) { // large size fonts for top 3
						current += "<tr><td><span class='top" + i + "'>" + topWords[i][0] +
							"</span></td><td><span class='top" + i + "'>" + topWords[i][1] + "</span></td>" +
							"<td>" + roundNumber(topWords[i][2], 2) + "</td></tr>";
					} else {
						current += "<tr><td>" + topWords[i][0] + "</td><td>" + topWords[i][1] + "</td>" +
							"<td>" + roundNumber(topWords[i][2], 2) + "</td></tr>";
					}
				}
				current += "</table>";

				topWordTables.push(current);
			}
			var tableOfTables = "<table width='650px'>";
			for (var i in topWordTables) {
				if (i % 2 == 0) {
					tableOfTables += "<tr><td>" + topWordTables[i] + "</td>";
				} else {
					tableOfTables += "<td>" + topWordTables[i] + "</td></tr>";
				}
			}

	
			// Create tables/graphs from the results
			$("#tableContainer").html(statTable);
			$("#wordsContainer").html(tableOfTables);
			createPieChart("pieChartContainer", "Message Contribution", pieChartData);
			$("#buttonContainer").html("<a href='javascript:returnToUploader()' class='button'>Return</a>");

			$("#messageContainer").hide();
			$("#formContainer").hide("fast");
			$("#resultsContainer").hide();
			$("#resultsContainer").show("fast");


		} else {
			$("#messageContainer").hide();
			$("#messageContainer").html("<p class='text_center red'><strong>Empty chat log provided.</strong></p>");
			$("#messageContainer").show("slow").delay(3500).hide("slow");
		}
	}

	function returnToUploader() {
		$("#buttonContainer").html("<a href='javascript:analyse()'' class='button'>Analyse</a><br /><br />");
		$("#resultsContainer").hide("fast");
		$("#formContainer").show("fast");
	}
	</script>

	<link rel="stylesheet" type="text/css" href="../css/reset.css" />
	<link rel="stylesheet" type="text/css" href="../css/style.css" />

</head>

<body>

	<div id="container" class="rounded_corners_all">
		<div id="header" class="rounded_corners_top">
			<h1>Chat Log Analyser</h1>
		</div>

		<div id="content">
			<div id="formContainer">
				<form name="logForm" action="#">
					<table class="form_table">
						<!--<tr><td><strong>Upload File:</strong></td>
						<td><input name="localFile" type="file" onchange="onFileChange()" /></td></tr>
						<tr><td><strong>URL:</strong></tds>
						<td><input name="url" type="text" class="textbox" onchange="onURLChange()" /></td></tr>-->

						<tr><td><strong>Raw Text:</strong></td></tr>
						<tr><td colspan="2"><textarea name="rawText" rows="15" cols="150"></textarea></td></tr>
					</table>
				</form>
				<!-- Contains messages (typically error messages) to show to the user. -->
				<div id="messageContainer"></div>
				<br />
			</div>

			<!-- Empty at the moment, just here so the div is created. -->
			<div id="resultsContainer">
				<div id="tableContainer"></div>
				<div id="pieChartContainer"></div>
				<div id="wordsContainer"></div>
			</div>

			<div id="buttonContainer">
				<a href="javascript:analyse()" class="button">Analyse</a>
				<br />
				<br />
			</div>
		</div>

		<div id="footer" class="rounded_corners_bottom">
			<p>Copyright 2011 Donald Whyte</p>
		</div>
	</div>

	<!-- We center the container here since it's been populated with all
	     its content by this point. -->
	<script type="text/javascript">
		$("#container").center();
		$("#resultsContainer").hide();
	</script>

</body>

</html>
